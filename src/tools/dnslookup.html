<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNS Lookup</title>
    <link rel="stylesheet" href="../style.css">
</head>

<body>
    <div class="wrapper">
        <h2>DNS Lookup</h2>
        <a href="../index.html">Back</a>

        <div id="form">
            <label for="domainInput">Domain Lookup: </label>
            <input type="text" id="domainInput" value="downe.com.au">
            <button onclick="dostuff()">Go!</button>
        </div>

        <div id="dnsresult"></div>

    </div>

    <script>
        // Main DNS Lookup function
        function dostuff() {

            async function lookup(item) {
                try {
                    var response = await fetch('https://dns.google/resolve?name=' + domain + '&type=' + item);

                    document.getElementById("dnsresult").innerHTML += `<h3>${item} records</h3>`;

                    // Check if the fetch was successful
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    var dnsreply = await response.json();

                    // Check if dnsreply.Answer exists and has valid data
                    if (dnsreply.Answer && dnsreply.Answer.length > 0) {
                        console.log(dnsreply.Answer)
                        document.getElementById("dnsresult").appendChild(createTable(dnsreply.Answer));
                    } else {
                        document.getElementById("dnsresult").innerHTML += `No ${item} records found.`;
                    }

                } catch (error) {
                    console.error(`Error fetching DNS record for type: ${item}`, error);
                }
            }

            // Get domain from search box
            const domain = document.getElementById('domainInput').value;

            document.getElementById("dnsresult").innerHTML = `<h1>DNS records for ${domain}</h1>`;

            // Define all the record types to look up and search through
            const recordtypes = ['A', 'AAAA', 'CNAME', 'TXT', 'NS', 'MX'];

            // Do a DNS lookup for each type of record - This way runs asynchronusly and ends up jumbling all the results
            // recordtypes.forEach(lookup);

            // This method does it one by one so it doesn't jumble up
            async function performLookups() {
                for (const type of recordtypes) {
                    await lookup(type);
                }
            }

            performLookups();

        }

        function createTable(data) {
            // Define the columns and their order
            const includeColumns = ["data", "TTL"];

            // Create the table element
            const table = document.createElement('table');

            // Create and append the table header in the specified order
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            includeColumns.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create and append the table body in the specified order
            const tbody = document.createElement('tbody');
            data.forEach(rowData => {
                const row = document.createElement('tr');
                includeColumns.forEach(key => {
                    const td = document.createElement('td');
                    td.textContent = rowData[key];
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
            table.appendChild(tbody);

            return table;
        }


    </script>

</body>

</html>